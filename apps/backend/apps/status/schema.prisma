// Status Page Models
// Implements Requirements 18.1-18.12

// Component status tracking
model ComponentStatus {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "API", "Database", "File Storage", "Email Service", "Authentication"
  description String?
  status      String   // "operational", "degraded", "partial_outage", "major_outage"
  lastChecked DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  
  // Uptime tracking
  uptimeRecords UptimeRecord[]
  
  // Incidents affecting this component
  incidents IncidentComponent[]
  
  @@map("component_status")
}

// Uptime tracking records
model UptimeRecord {
  id          String   @id @default(uuid())
  componentId String
  component   ComponentStatus @relation(fields: [componentId], references: [id], onDelete: Cascade)
  
  isUp        Boolean  // true if component was operational
  checkedAt   DateTime @default(now())
  
  @@index([componentId, checkedAt])
  @@map("uptime_records")
}

// Incident tracking
model Incident {
  id          String   @id @default(uuid())
  title       String
  description String
  status      String   // "investigating", "identified", "monitoring", "resolved"
  severity    String   // "minor", "major", "critical"
  
  startedAt   DateTime @default(now())
  resolvedAt  DateTime?
  
  // Root cause and resolution details
  rootCause   String?
  resolution  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Affected components
  affectedComponents IncidentComponent[]
  
  // Status updates
  updates     IncidentUpdate[]
  
  @@map("incidents")
}

// Many-to-many relationship between incidents and components
model IncidentComponent {
  id          String   @id @default(uuid())
  incidentId  String
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  componentId String
  component   ComponentStatus @relation(fields: [componentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([incidentId, componentId])
  @@map("incident_components")
}

// Incident status updates
model IncidentUpdate {
  id          String   @id @default(uuid())
  incidentId  String
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  message     String
  status      String   // Current incident status at time of update
  
  // Optional ETA for resolution
  estimatedResolution DateTime?
  
  createdAt   DateTime @default(now())
  createdBy   String?  // Admin user ID who posted the update
  
  @@index([incidentId, createdAt])
  @@map("incident_updates")
}

// Scheduled maintenance windows
model MaintenanceWindow {
  id          String   @id @default(uuid())
  title       String
  description String
  
  scheduledStart DateTime
  scheduledEnd   DateTime
  
  // Actual start/end times
  actualStart    DateTime?
  actualEnd      DateTime?
  
  status      String   // "scheduled", "in_progress", "completed", "cancelled"
  
  // Affected components
  affectedComponents String[] // Array of component IDs
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // Admin user ID
  
  @@map("maintenance_windows")
}

// Status page subscriptions
model StatusSubscription {
  id          String   @id @default(uuid())
  email       String?
  phone       String?  // For SMS notifications
  
  // Subscription preferences
  notifyOnIncidents    Boolean @default(true)
  notifyOnMaintenance  Boolean @default(true)
  notifyOnResolution   Boolean @default(true)
  
  isActive    Boolean  @default(true)
  
  // Verification
  verified    Boolean  @default(false)
  verificationToken String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([email])
  @@index([phone])
  @@map("status_subscriptions")
}
