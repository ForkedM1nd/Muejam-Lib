# MVP Documentation — Digital Library + Serials + Whispers (Minimal)

## 0) Product Vision

### 0.1 What this is

A calm, minimal platform where people:

* **Read** serial stories/books in a distraction-free reader
* **Save** stories into their personal **Library (shelves)**
* Post **Whispers** (short posts) globally or attached to a **story** or a **highlighted passage**

### 0.2 Why it feels new

Whispers aren’t “random social noise”—they’re **lightweight reactions around reading**:

* A whisper can be **global**, **story-linked**, or **passage-linked**
* Passage-linked whispers (from highlights) create a unique “reading community” feel without clutter

---

# 1) UX Principles (Non-Negotiable)

### 1.1 Minimal UI rules

* **Typography-first** (reading is the hero)
* **No dense sidebars** in the reader
* Max **2 primary actions per view**
* Use **whitespace + soft separators**, no heavy borders
* **Stable navigation** (same top bar everywhere)

### 1.2 Comfort rules

* Reader settings: font size, line width, theme
* Pagination and feeds are **cursor-based** (smooth infinite scroll)
* Everything must be usable **one-handed on mobile**

---

# 2) MVP Scope

## 2.1 MVP includes

### Reading

* Discover stories (Trending / New / For You)
* Story page + chapters list
* Reader mode + progress tracking
* Like / Save to shelf / Bookmark

### Writing

* Create story draft
* Create chapter drafts
* Publish chapter + story

### Whispers

* Post global whisper
* Post whisper attached to story
* Highlight passage → whisper that highlight
* Replies + likes
* Notifications (in-app + email for key events)

### Search + Suggest + Personalization (MVP-level)

* Search stories/authors/tags
* Search suggestions as you type
* “For You” ranking based on user behavior signals (simple, explainable)

### Safety

* Report, block, soft-delete

## 2.2 MVP does NOT include

* Payments/subscriptions
* Advanced recommender ML
* Full moderation dashboard (beyond minimal admin tools)
* Real-time chat

---

# 3) Tech Stack & Architecture

* **Front:** Next.js (App Router)
* **Back:** Django + DRF
* **DB:** PostgreSQL + Prisma
* **Cache:** Valkey
* **Auth:** Clerk (`clerk-backend-api`)
* **Emails:** Resend
* **Upload:** S3 (presigned)

## 3.1 Request flow (clean separation)

1. Next.js renders UI + gets session from Clerk
2. Next.js calls Django API with Clerk token
3. Django verifies via `clerk-backend-api`
4. Django reads/writes Postgres via Prisma
5. Valkey caches feeds/search hot results
6. Resend emails triggered by events (async worker)
7. S3 for media via presigned uploads

> Prisma in Python: for MVP you can use **Prisma Client Python**. If you want the safest “boring” path later, you can keep Prisma for schema/migrations and access DB with Django ORM, but since you asked “Postgres + Prisma”, this doc assumes **Prisma client in Django**.

---

# 4) Information Architecture (Minimal Routes)

Top nav: **Discover · Library · Write · Whispers · Profile** + Search

## 4.1 Pages

* `/discover` (Trending / New / For You)
* `/story/[slug]` (story overview)
* `/read/[chapterId]` (reader)
* `/whispers` (global feed)
* `/library` (shelves)
* `/write` (author dashboard)
* `/write/story/[id]` (edit + chapters)
* `/u/[handle]` (profile)

---

# 5) Search + Suggest + Personalization (Start Here)

This section is intentionally simple and MVP-safe.

## 5.1 Search goals

* Fast and calm: **results within 200–400ms**
* Search across:

  * Stories (title, blurb)
  * Authors (handle, display name)
  * Tags

## 5.2 Search implementation (MVP)

Use **PostgreSQL full-text search** + trigram for suggestions:

### Tables / indexes

* `Story.search_tsv` (generated from `title + blurb`)
* GIN index on `search_tsv`
* Trigram index on `Story.title`, `UserProfile.handle`, `Tag.name`

### Endpoints

* `GET /v1/search?q=...&type=all|stories|users|tags&cursor=...`
* `GET /v1/search/suggest?q=...&limit=8`

### Ranking (simple)

* Base rank: Postgres FTS rank
* Boosts:

  * published recently (+)
  * trending score (+)
  * exact prefix match (+)

## 5.3 Suggest (autocomplete)

Return 3 groups (max 8 total):

* **Stories** (top 4)
* **Tags** (top 2)
* **Authors** (top 2)

Cache suggestions in Valkey:

* `suggest:{normalized_prefix}` TTL 10–30 min

## 5.4 Personalization (“For You”) — MVP algorithm

We keep it explainable and low-risk.

### Signals (all optional; works with cold start)

1. **Tag affinity** from:

   * saved stories’ tags
   * read time per tag
   * likes on whispers/story
2. **Author affinity**

   * follows
   * repeated reading
3. **Freshness**
4. **Popularity/trending**

### User preference model (simple)

Maintain a `UserInterest` table:

* `user_id`
* `tag_id`
* `score` (float)
* `updated_at`

Update scores whenever user:

* saves a story (+3)
* reads a chapter > 60s (+1)
* likes a story (+2)
* follows author (+2 to that author’s tags)

Decay daily:

* `score = score * 0.98`

### For You scoring

For each candidate story:

`score =  (tag_match * 3) + (author_match * 2) + (trending * 1.5) + (freshness * 1.0)`

Where:

* `tag_match`: sum of user tag scores that story has
* `author_match`: +X if user follows author or read them before
* `trending`: normalized 0..1 from last 24h
* `freshness`: normalized 0..1 from publish date

### Candidate generation (MVP)

* Start from:

  * recent published stories (last 30 days)
  * trending list
  * stories from followed authors
* Filter out:

  * blocked authors
  * deleted/unlisted

### Caching

* Precompute top 200 story IDs per user daily or hourly:

  * Valkey: `foryou:{user_id}` list (TTL 1–6 hours)
* If not ready: fallback to Trending/New

---

# 6) Data Model (Prisma)

Core entities:

## 6.1 Users

* `UserProfile(id, clerk_user_id, handle, display_name, bio, avatar_key, created_at, updated_at)`

## 6.2 Stories

* `Story(id, author_id, title, slug, blurb, cover_key, language, status, is_deleted, published_at, created_at, updated_at)`
* `Chapter(id, story_id, number, title, content_md, word_count, status, published_at, created_at, updated_at)`
* `Tag(id, name, slug)`
* `StoryTag(story_id, tag_id)`

## 6.3 Library

* `Shelf(id, user_id, name, is_private, created_at)`
* `ShelfItem(shelf_id, story_id, added_at)`

## 6.4 Reading state

* `ReadingProgress(user_id, chapter_id, progress, last_read_at)`
* `Bookmark(id, user_id, chapter_id, position, note, created_at)`

## 6.5 Highlights

* `Highlight(id, user_id, chapter_id, start_offset, end_offset, quote_text, created_at)`

## 6.6 Whispers

* `Whisper(id, author_id, body, media_key, scope, story_id?, highlight_id?, parent_id?, like_count, reply_count, is_deleted, created_at)`
* `WhisperLike(user_id, whisper_id, created_at)`

## 6.7 Social + Notifications

* `Follow(follower_id, following_id, created_at)`
* `Notification(id, user_id, type, actor_id, entity_type, entity_id, created_at, read_at?)`

## 6.8 Safety

* `Report(id, reporter_id, entity_type, entity_id, reason, notes?, status, created_at)`
* `Block(user_id, blocked_user_id, created_at)` ✅ (recommended add)

## 6.9 Personalization (added)

* `UserInterest(user_id, tag_id, score, updated_at)` ✅
* `StoryStatsDaily(story_id, reads_24h, likes_24h, saves_24h, whispers_24h, updated_at)` ✅ (optional but helpful)

---

# 7) API Contract (Django DRF)

Base: `/v1`

## 7.1 Public

* `GET /stories?sort=trending|new|foryou&tag=&q=&cursor=`
* `GET /stories/{slug}`
* `GET /stories/{id}/chapters`
* `GET /chapters/{id}`
* `GET /whispers?scope=global|story|highlight&story_id=&cursor=`
* `GET /search?q=&type=&cursor=`
* `GET /search/suggest?q=&limit=`

## 7.2 Authenticated (Clerk required)

### Me

* `GET /me`
* `GET /me/notifications?cursor=`
* `POST /me/notifications/{id}/read`
* `GET /me/shelves`
* `POST /me/shelves`
* `PUT /me/shelves/{id}`
* `DELETE /me/shelves/{id}`
* `POST /me/shelves/{id}/items` {story_id}
* `DELETE /me/shelves/{id}/items/{story_id}`

### Social

* `POST /users/{handle}/follow`
* `DELETE /users/{handle}/follow`
* `POST /users/{handle}/block` ✅
* `DELETE /users/{handle}/block` ✅

### Writing

* `POST /stories`
* `PUT /stories/{id}`
* `POST /stories/{id}/publish`
* `POST /stories/{id}/chapters`
* `PUT /chapters/{id}`
* `POST /chapters/{id}/publish`
* `DELETE /stories/{id}` (soft delete)

### Whispers

* `POST /whispers`
* `POST /whispers/{id}/reply`
* `POST /whispers/{id}/like`
* `DELETE /whispers/{id}/like`
* `DELETE /whispers/{id}` (soft delete)

### Highlights

* `POST /highlights`
* `DELETE /highlights/{id}`

### Uploads

* `POST /uploads/presign` → {object_key, upload_url/fields, public_url?}

### Reports

* `POST /reports`

---

# 8) Feeds, Trending & Caching (Valkey)

## 8.1 What to cache

* Discover pages: `discover:new:*`, `discover:trending:*` TTL 1–5 min
* Whispers feeds: `whispers:*` TTL 30–120 sec
* Search suggest: `suggest:*` TTL 10–30 min
* Story metadata: `story:{id}` TTL 5–15 min

## 8.2 Trending (MVP)

Compute every 10–30 minutes:

`trend = reads_24h*1 + likes_24h*2 + saves_24h*2 + whispers_24h*1.5`

Store in sorted set: `zset:trending:stories`

---

# 9) Emails (Resend)

MVP emails:

* New reply to your whisper
* New follower (optional)
* Story published (optional)

Rules:

* Email is secondary to in-app notifications
* Use idempotency on send jobs to prevent duplicates

---

# 10) Uploads (S3)

## 10.1 Presigned flow

1. Client requests presign
2. Client uploads direct to S3
3. Client saves `object_key` in DB

Allowed types:

* avatar: jpg/png/webp, <=2MB
* cover: jpg/png/webp, <=5MB
* whisper media: jpg/png/webp, <=10MB

---

# 11) Content Rendering & Safety (Important for MVP)

✅ **Markdown rendering**

* Store `content_md`
* Render in Next.js
* Sanitize HTML output (avoid XSS)

✅ **Soft deletes**

* Stories/chapters/whispers use `is_deleted`
* Hide from public feeds but keep for moderation

✅ **Rate limiting (Valkey)**

* whispers create: 10/min
* replies: 20/min
* publish: small (anti-spam)

✅ **Block**

* Blocked users’ content removed from feeds/search results for blocker

---

# 12) Observability & Analytics (Don’t skip)

## 12.1 Logging & tracing (minimal)

* Request ID per API call
* Structured logs: auth_user_id, route, latency, status
* Error reporting (Sentry recommended)

## 12.2 Product analytics events (minimal)

* story_opened
* chapter_read_started
* chapter_read_60s
* story_saved
* whisper_created
* highlight_created
* search_performed
* suggestion_clicked

These power personalization and help product decisions.

---

# 13) Local Development (Recommended)

Docker services:

* Postgres
* Valkey
* (Optional) MinIO for S3 local
* Django API
* Next.js web

Dev workflow:

* Prisma migrate
* Django runserver
* Next dev

---

# 14) Acceptance Criteria (MVP “Done”)

Must pass flows:

1. Sign in via Clerk and call protected endpoints
2. Discover → open story → open chapter → progress saved
3. Create shelf → save/remove story
4. Create story + chapter → publish → appears in New
5. Whisper global + reply + like works
6. Highlight passage → whisper attached to highlight
7. Upload cover/avatar works end-to-end
8. Notifications appear in-app; at least reply emails send

---


