# PostgreSQL Backup Configuration for MueJam

# Database Configuration
database:
  host: ${DB_HOST}
  port: ${DB_PORT}
  name: ${DB_NAME}
  user: ${DB_USER}
  password: ${PGPASSWORD}

# Backup Schedule
schedule:
  # Full backup daily at 2 AM
  full_backup:
    cron: "0 2 * * *"
    enabled: true
  
  # Incremental backup every 6 hours
  incremental_backup:
    cron: "0 */6 * * *"
    enabled: false
  
  # Transaction log backup every hour
  wal_backup:
    cron: "0 * * * *"
    enabled: false

# Backup Storage
storage:
  # Storage type: local, s3, azure, gcs
  type: ${BACKUP_STORAGE_TYPE:-local}
  
  # Local storage
  local:
    path: /var/backups/postgres
    
  # AWS S3
  s3:
    bucket: ${S3_BUCKET}
    region: ${AWS_REGION:-us-east-1}
    storage_class: STANDARD_IA  # or GLACIER, DEEP_ARCHIVE
    
  # Azure Blob Storage
  azure:
    container: ${AZURE_CONTAINER}
    tier: Cool  # or Hot, Archive
    
  # Google Cloud Storage
  gcs:
    bucket: ${GCS_BUCKET}
    storage_class: NEARLINE  # or COLDLINE, ARCHIVE

# Backup Retention
retention:
  # Keep daily backups for 30 days
  daily: 30
  
  # Keep weekly backups for 12 weeks
  weekly: 12
  
  # Keep monthly backups for 12 months
  monthly: 12
  
  # Keep yearly backups for 7 years
  yearly: 7

# Encryption
encryption:
  enabled: true
  algorithm: aes-256-cbc
  key_file: /etc/backup/encryption.key
  # Generate key with: openssl rand -base64 32 > /etc/backup/encryption.key

# Compression
compression:
  enabled: true
  level: 9  # 1-9, higher = better compression but slower

# Notifications
notifications:
  # Slack webhook for backup notifications
  slack:
    enabled: ${BACKUP_SLACK_ENABLED:-false}
    webhook_url: ${BACKUP_SLACK_WEBHOOK_URL}
    channel: "#ops-alerts"
    
  # Email notifications
  email:
    enabled: ${BACKUP_EMAIL_ENABLED:-false}
    recipients:
      - ops@example.com
      - dba@example.com
    smtp_host: ${SMTP_HOST}
    smtp_port: ${SMTP_PORT:-587}
    smtp_user: ${SMTP_USER}
    smtp_password: ${SMTP_PASSWORD}

# Monitoring
monitoring:
  # Send metrics to monitoring system
  enabled: true
  
  # Alert if backup fails
  alert_on_failure: true
  
  # Alert if backup takes longer than threshold
  duration_threshold_minutes: 60
  
  # Alert if backup size changes significantly
  size_change_threshold_percent: 50

# Backup Verification
verification:
  # Verify backup integrity after creation
  enabled: true
  
  # Test restore on separate database
  test_restore:
    enabled: false
    schedule: "0 3 * * 0"  # Weekly on Sunday at 3 AM
    test_database: muejam_restore_test

# Performance
performance:
  # Number of parallel jobs for pg_dump
  jobs: 4
  
  # Nice level for backup process (lower priority)
  nice_level: 10
  
  # IO nice level (best-effort, lower priority)
  ionice_class: 2
  ionice_level: 7

# Logging
logging:
  level: INFO  # DEBUG, INFO, WARNING, ERROR
  file: /var/log/postgres-backup.log
  max_size_mb: 100
  max_files: 10
